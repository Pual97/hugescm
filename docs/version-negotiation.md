# 版本协商备忘录

## 分支基线

在 HugeSCM 客户端，我们存在一个分支基线的概念，这个基线标记了存储库从远程存储库的某个提交开发向前发展，我们计算对象变更时会从基线开始计算，对于多个分支，我们会保留多个基线。我们在 Fetch/Push 这些阶段严格依赖基线以实现版本协商。

这和 Git 类似，Git 浅表克隆+稀疏检出时，会在存储库中保留一个 shallow 文件，但该文件系全局的，因此也就无法对多个分支实现 shallow 控制，在拉取其他分支时，往往也需要依赖此 shallow 文件。除非用户更改，否则 shallow 是不改变的，这样的结果是 Git shallow 克隆的仓库体积还是会随着时间膨胀。

### 基线重置

在 Fetch/Push 后，远程分支发生改变后，客户端可以修改分支基线到最新的 commit。

## 检出

检出 ==> 拉取 + 重置

在 HugeSCM 中，我们将远程存储库创建到本地的浅表副本，本检出的操作称之为检出，也就是 checkout，别名 co。其步骤如下：

1. 初始化存储库本地目录，包含工作区，`.zeta` 等。
2. 获取需要检出的分支，标签或提交，这里需要使用引用发现协议。对于检出特定 commit 的操作，忽略引用发现获得的 commit/peeled commit。
3. 使用获取的 commit/或者特定 commit 获取元数据。
4. 拉取 objects（blobs），这里的对象清点请基于第三步获得的对象。
5. 重置索引，检出所有文件。

## 拉取

在 HugeSCM 中，我们从服务端拉取数据的步骤是：
1. 获得远程引用信息
2. 下载元数据。
3. 批量下载 blobs。
4. 下载大的 blobs（如果有）。
5. 记录引用的信息到本地。

### Deepen-From


## 合并

## 推送